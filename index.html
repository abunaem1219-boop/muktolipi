<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶Æ‡ßÅ‡¶ï‡ßç‡¶§‡¶≤‡¶ø‡¶™‡¶ø ‡¶°‡¶æ‡ßü‡ßá‡¶∞‡¶ø</title>
    
    <!-- PWA Manifest & Meta Tags -->
    <meta name="theme-color" content="#1877f2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIuKbnOCljeCkpOCmsuCkv+CKr+Ckv+CqpSDgpqHgprLgp9uCprDgpL8iLAogICJzaG9ydF9uYW1lIjogIuKbnOCljeCkpOCmsuCkv+CKr+Ckv+CqpSIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZmZmZmZmIiwKICAidGhlbWVfY29xvciI6ICIjMTg3N2YyIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiaHR0cHM6Ly9pLmliYi5jby9WV1ZtMFh5L011a3RvbGlwaS1CYW5uZXIuanBnIiwKICAgICAgInNpemVzIjogIjE5MngxOTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9qcGVnIgogICAgfSwKICAgIHsKICAgICAgInNyYyI6ICJodHRwczovL2kuaWJiLmNvL1ZXVm0wWHkvTXVrdG9saXBpLUJhbm5lci5qcGciLAogICAgICAic2l6ZXMiOiAiNTEyeDUxMiIsCiAgICAgICJ0eXBlIjogImltYWdlL2pwZWciCiAgICB9CiAgXQp9">

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root { 
            --bg-color: #f0f2f5; 
            --card-bg: #ffffff; 
            --text-color: #1c1e21; 
            --primary-color: #1877f2; 
            --border-color: #ddd; 
            --secondary-text: #65676b; 
            --content-font-size: 16px;
            --highlight-color: #ffe066;
            --nav-bg: #ffffff;
            --shadow-soft: 0 4px 12px rgba(0,0,0,0.05);
            --shadow-card: 0 2px 8px rgba(0,0,0,0.08);
        }
        .dark-theme { 
            --bg-color: #18191a; 
            --card-bg: #242526; 
            --text-color: #e4e6eb; 
            --primary-color: #4595ff; 
            --border-color: #3e4042; 
            --secondary-text: #b0b3b8; 
            --highlight-color: #bfa11e;
            --nav-bg: #242526;
            --shadow-soft: 0 4px 12px rgba(0,0,0,0.3);
            --shadow-card: 0 2px 8px rgba(0,0,0,0.3);
        }

        body { font-family: 'Hind Siliguri', sans-serif; background: var(--bg-color); color: var(--text-color); margin: 0; padding: 10px; transition: 0.3s; user-select: none; -webkit-tap-highlight-color: transparent; padding-bottom: 120px; }

        /* Banner & Header */
        .app-banner { width: 100%; max-width: 981px; margin: 0 auto 20px auto; border-radius: 16px; overflow: hidden; box-shadow: var(--shadow-soft); }
        .app-banner img { width: 100%; height: auto; aspect-ratio: 981 / 363; object-fit: cover; display: block; }

        header { text-align: center; padding: 15px; background: var(--card-bg); border-radius: 16px; margin-bottom: 20px; position: relative; box-shadow: var(--shadow-soft); max-width: 800px; margin-left: auto; margin-right: auto; }
        
        .header-controls { position: absolute; top: 15px; right: 15px; display: flex; gap: 15px; }
        .icon-btn { cursor: pointer; font-size: 20px; background: none; border: none; color: var(--text-color); transition: 0.2s; }
        
        .container { max-width: 800px; margin: 0 auto; }
        
        /* Search */
        .search-wrapper { position: relative; width: 100%; margin-bottom: 10px; }
        #searchBar { width: 100%; padding: 12px 40px 12px 20px; border-radius: 30px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-color); outline: none; box-sizing: border-box; box-shadow: var(--shadow-soft); }
        .search-clear { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--secondary-text); cursor: pointer; display: none; font-size: 16px; }
        mark { background-color: var(--highlight-color); color: black; border-radius: 2px; padding: 0 2px; }

        /* Category Tabs */
        .category-tabs { display: flex; gap: 10px; overflow-x: auto; padding: 5px 0 15px 0; scrollbar-width: none; }
        .category-tabs::-webkit-scrollbar { display: none; }
        .cat-btn { white-space: nowrap; padding: 8px 18px; border-radius: 20px; border: none; background: var(--card-bg); color: var(--text-color); cursor: pointer; font-size: 14px; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .cat-btn.active { background: var(--primary-color); color: white; box-shadow: 0 4px 10px rgba(24, 119, 242, 0.3); }

        /* Modern Post Card */
        .post-card { background: var(--card-bg); padding: 20px; border-radius: 20px; margin-bottom: 20px; box-shadow: var(--shadow-card); position: relative; overflow: hidden; border: none; }
        .pinned-badge { position: absolute; top: 20px; right: 20px; color: #e74c3c; font-size: 18px; transform: rotate(45deg); z-index: 2; }
        .category-tag { background: rgba(24, 119, 242, 0.1); color: var(--primary-color); padding: 3px 10px; border-radius: 12px; font-size: 11px; margin-left: 8px; font-weight: 600; }

        .author-info { font-size: 15px; font-weight: bold; color: var(--text-color); display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .date { font-size: 12px; color: var(--secondary-text); display: block; font-weight: normal; }
        .post-title { font-size: 22px; margin: 8px 0 12px 0; font-weight: 700; line-height: 1.3; }
        
        .post-img-container { position: relative; width: 100%; border-radius: 12px; overflow: hidden; margin: 10px 0; }
        .post-img { width: 100%; display: block; cursor: pointer; max-height: 450px; object-fit: cover; }
        
        /* Content & Read More Gradient */
        .content-preview { white-space: pre-line; line-height: 1.6; font-size: var(--content-font-size); color: var(--text-color); position: relative; transition: font-size 0.2s; }
        
        .read-more-wrapper { position: relative; overflow: hidden; max-height: 160px; transition: max-height 0.3s ease; }
        .read-more-wrapper.expanded { max-height: none; }
        
        /* Gradient Overlay */
        .read-more-overlay::after {
            content: ""; position: absolute; bottom: 0; left: 0; width: 100%; height: 80px;
            background: linear-gradient(to bottom, transparent, var(--card-bg));
            pointer-events: none;
        }

        .heart-popup { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); color: #e74c3c; font-size: 80px; animation: popHeart 0.8s ease-out; pointer-events: none; z-index: 10; opacity: 0; drop-shadow: 0 0 5px rgba(0,0,0,0.5); }
        @keyframes popHeart { 0% { transform: translate(-50%, -50%) scale(0); opacity: 0; } 50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(1); opacity: 0; } }

        .read-more-btn { color: var(--primary-color); cursor: pointer; font-weight: bold; border: none; background: none; padding: 5px 0; margin-top: 5px; font-size: 14px; }

        /* Audio Button */
        .audio-trigger-btn { display: flex; align-items: center; gap: 10px; background: rgba(24, 119, 242, 0.05); padding: 8px 15px; border-radius: 20px; color: var(--primary-color); font-weight: bold; margin: 10px 0; cursor: pointer; width: fit-content; transition: 0.2s; }
        .audio-trigger-btn:hover { background: var(--primary-color); color: white; }

        /* Interaction Bar */
        .interaction-bar { display: flex; justify-content: space-between; border-top: 1px solid var(--border-color); padding-top: 12px; margin-top: 15px; }
        .action-btn { background: none; border: none; cursor: pointer; color: var(--secondary-text); font-size: 15px; display: flex; align-items: center; gap: 8px; padding: 5px; transition: 0.2s; }
        .action-btn:hover { background: rgba(0,0,0,0.05); border-radius: 5px; }
        .action-btn.liked { color: var(--primary-color); }
        .action-btn.bookmarked { color: #f39c12; }

        /* Skeleton Loader (Shimmer) */
        .skeleton-card { background: var(--card-bg); padding: 20px; border-radius: 20px; margin-bottom: 20px; box-shadow: var(--shadow-card); }
        .sk-anim { background: linear-gradient(90deg, var(--bg-color) 25%, var(--border-color) 50%, var(--bg-color) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 4px; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        
        .sk-header { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .sk-avatar { width: 40px; height: 40px; border-radius: 50%; }
        .sk-name { width: 120px; height: 14px; }
        .sk-title { width: 80%; height: 24px; margin-bottom: 15px; }
        .sk-img { width: 100%; height: 200px; border-radius: 12px; margin-bottom: 15px; }
        .sk-line { width: 100%; height: 12px; margin-bottom: 8px; }
        .sk-line.short { width: 60%; }

        /* Bottom Navigation Bar */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--nav-bg); height: 60px; display: flex; justify-content: space-around; align-items: center; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1500; border-top-left-radius: 15px; border-top-right-radius: 15px; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--secondary-text); background: none; border: none; font-size: 12px; cursor: pointer; flex: 1; }
        .nav-item i { font-size: 20px; margin-bottom: 4px; transition: 0.2s; }
        .nav-item.active { color: var(--primary-color); }
        .nav-item.active i { transform: translateY(-2px); }

        /* Admin FAB & Modal */
        #adminFab { position: fixed; bottom: 80px; right: 20px; background: var(--primary-color); color: white; border: none; border-radius: 50%; width: 55px; height: 55px; cursor: pointer; box-shadow: 0 4px 15px rgba(24, 119, 242, 0.4); font-size: 24px; z-index: 1400; display: none; align-items: center; justify-content: center; transition: transform 0.2s; }
        #adminFab:active { transform: scale(0.9); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2100; display: none; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; backdrop-filter: blur(5px); }
        .modal-content { background: var(--card-bg); padding: 25px; border-radius: 16px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        input, textarea, select { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid var(--border-color); border-radius: 10px; background: var(--bg-color); color: var(--text-color); font-family: inherit; box-sizing: border-box; outline: none; }
        input:focus, textarea:focus { border-color: var(--primary-color); }
        .btn { padding: 12px 20px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; transition: 0.2s; width: 100%; font-size: 16px; }
        .btn-primary { background: var(--primary-color); color: white; }

        /* Audio Visualizer Animation */
        #stickyPlayer { 
            position: fixed; bottom: -100px; left: 0; width: 100%; 
            background: var(--card-bg); border-top: 1px solid var(--border-color);
            padding: 10px 20px; box-sizing: border-box; box-shadow: 0 -5px 20px rgba(0,0,0,0.15);
            display: flex; align-items: center; justify-content: space-between; 
            transition: bottom 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 1200;
            border-top-left-radius: 15px; border-top-right-radius: 15px;
        }
        #stickyPlayer.active { bottom: 60px; /* Above Nav Bar */ }
        
        .visualizer { display: flex; align-items: flex-end; gap: 3px; height: 15px; margin-right: 10px; }
        .bar { width: 3px; background: var(--primary-color); height: 5px; border-radius: 2px; }
        .visualizer.playing .bar { animation: sound 0.5s infinite alternate; }
        .visualizer.playing .bar:nth-child(1) { animation-delay: 0.1s; }
        .visualizer.playing .bar:nth-child(2) { animation-delay: 0.3s; }
        .visualizer.playing .bar:nth-child(3) { animation-delay: 0.5s; }
        @keyframes sound { 0% { height: 5px; } 100% { height: 15px; } }

        /* Comments */
        .comment-area { display: none; margin-top: 15px; padding-top: 15px; border-top: 1px dashed var(--border-color); }
        .comment-item { background: var(--bg-color); padding: 10px 14px; border-radius: 12px; margin-bottom: 8px; font-size: 14px; width: fit-content; max-width: 90%; }
        
        /* Lightbox */
        .lightbox { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2200; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s; }
        .lightbox.active { opacity: 1; }
        .lightbox img { max-width: 95%; max-height: 80vh; border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .close-lightbox { position: absolute; top: 20px; right: 20px; color: white; font-size: 30px; cursor: pointer; }

        /* Utils */
        #scrollTopBtn { display: none; } /* Replaced by Bottom Nav functionality or can be kept hidden */
        #installBtn { display: none; background: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: 25px; margin-top: 15px; font-size: 14px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 10px rgba(24, 119, 242, 0.3); }
        
        .no-results { text-align: center; padding: 60px 20px; color: var(--secondary-text); }
        .admin-controls { margin-top: 15px; text-align: right; font-size: 13px; display: flex; justify-content: flex-end; gap: 10px; }
        .admin-controls button { padding: 5px 10px; border-radius: 5px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-color); cursor: pointer; }
    </style>
</head>
<body>

    <!-- Lightbox -->
    <div id="lightbox" class="lightbox" onclick="closeLightbox()">
        <span class="close-lightbox">&times;</span>
        <img id="lightbox-img" src="" alt="Full View">
    </div>

    <!-- Admin Modal -->
    <div id="adminModalWrapper" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 id="formTitle" style="margin:0;">‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßã‡¶∏‡ßç‡¶ü</h3>
                <button onclick="closeAdminModal()" style="background:none; border:none; font-size:20px; color:var(--text-color); cursor:pointer;"><i class="fas fa-times"></i></button>
            </div>
            
            <input type="hidden" id="editKey">
            <input type="text" id="authorName" placeholder="‡¶≤‡ßá‡¶ñ‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ">
            <input type="text" id="postTitle" placeholder="‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ">
            
            <select id="postCategory">
                <option value="‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø">‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>
                <option value="‡¶ó‡¶≤‡ßç‡¶™">‡¶ó‡¶≤‡ßç‡¶™</option>
                <option value="‡¶ï‡¶¨‡¶ø‡¶§‡¶æ">‡¶ï‡¶¨‡¶ø‡¶§‡¶æ</option>
                <option value="‡¶°‡¶æ‡ßü‡ßá‡¶∞‡¶ø">‡¶°‡¶æ‡ßü‡ßá‡¶∞‡¶ø</option>
                <option value="‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡¶ø‡¶ï">‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡¶ø‡¶ï</option>
                <option value="‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø">‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø</option>
            </select>

            <input type="text" id="postImage" placeholder="‡¶õ‡¶¨‡¶ø‡¶∞ ‡¶≤‡¶ø‡¶Ç‡¶ï (Direct Image URL)">
            <input type="text" id="voiceUrl" placeholder="‡¶Ö‡¶°‡¶ø‡¶ì ‡¶≤‡¶ø‡¶Ç‡¶ï (Direct mp3 URL)">
            <textarea id="postContent" rows="6" placeholder="‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®... (*‡¶¨‡ßã‡¶≤‡ßç‡¶°*, _‡¶á‡¶ü‡¶æ‡¶≤‡¶ø‡¶ï_)"></textarea>
            
            <label style="display:flex; align-items:center; margin-bottom:20px; font-size:14px; color:var(--text-color); cursor:pointer;">
                <input type="checkbox" id="isPinned" style="width:auto; margin-right:10px; transform:scale(1.2);">
                üìå ‡¶è‡¶á ‡¶™‡ßã‡¶∏‡ßç‡¶ü‡¶ü‡¶ø ‡¶∏‡¶¨‡¶æ‡¶∞ ‡¶â‡¶™‡¶∞‡ßá ‡¶™‡¶ø‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®
            </label>

            <button class="btn btn-primary" id="submitBtn" onclick="savePost()">‡¶™‡¶æ‡¶¨‡¶≤‡¶ø‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            <button class="btn" onclick="logout()" style="margin-top:10px; background: #e4e6eb; color: #1c1e21;">‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</button>
        </div>
    </div>

    <!-- Sticky Floating Audio Player -->
    <div id="stickyPlayer">
        <div style="display:flex; align-items:center;">
            <!-- Visualizer -->
            <div class="visualizer" id="audioVisualizer">
                <div class="bar"></div><div class="bar"></div><div class="bar"></div>
            </div>
            <div class="player-info">
                <div class="p-title" id="globalPlayerTitle" style="font-weight:bold; font-size:14px;">Title</div>
                <div class="p-author" id="globalPlayerAuthor" style="font-size:12px; color:var(--secondary-text);">Author</div>
            </div>
        </div>
        <div class="player-controls" style="display:flex; gap:15px; align-items:center;">
            <button onclick="toggleGlobalAudio()" style="background:none; border:none; font-size:26px; color:var(--primary-color); cursor:pointer;">
                <i class="fas fa-play" id="globalPlayIcon"></i>
            </button>
            <button onclick="closeGlobalPlayer()" style="background:none; border:none; font-size:20px; color:var(--secondary-text); cursor:pointer;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <audio id="globalAudioElement" onended="onAudioEnded()"></audio>
    </div>

    <!-- Admin FAB -->
    <button id="adminFab" onclick="openAdminModal()"><i class="fas fa-plus"></i></button>

    <div class="container">
        <div class="app-banner">
            <!-- Replace with your actual banner if available, using placeholder for now -->
            <img src="https://i.ibb.co/VWVm0Xy/Muktolipi-Banner.jpg" alt="Banner" onerror="this.style.display='none'">
        </div>

        <header>
            <div class="header-controls">
                <button class="icon-btn" onclick="toggleFontSize()" title="‡¶´‡¶®‡ßç‡¶ü ‡¶∏‡¶æ‡¶á‡¶ú"><i class="fas fa-text-height"></i></button>
                <button class="icon-btn theme-toggle" onclick="toggleTheme()"><i class="fas fa-moon"></i></button>
            </div>
            <h1 style="margin: 0; color: var(--primary-color);">‡¶Æ‡ßÅ‡¶ï‡ßç‡¶§‡¶≤‡¶ø‡¶™‡¶ø ‡¶°‡¶æ‡ßü‡ßá‡¶∞‡¶ø</h1>
            <p style="margin: 5px 0 0 0; font-size: 14px; color: var(--secondary-text);">‡¶Æ‡¶®‡ßá‡¶∞ ‡¶ï‡¶•‡¶æ, ‡¶Æ‡ßÅ‡¶ï‡ßç‡¶§ ‡¶≠‡¶æ‡¶∑‡¶æ‡ßü</p>
            <button id="installBtn" onclick="installPWA()"><i class="fas fa-download"></i> ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶á‡¶®‡ßç‡¶∏‡¶ü‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </header>

        <!-- Search Bar -->
        <div class="search-wrapper">
            <input type="text" id="searchBar" placeholder="üîç ‡¶≤‡ßá‡¶ñ‡¶æ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." onkeyup="filterPosts(this.value)">
            <button class="search-clear" id="searchClearBtn" onclick="clearSearch()"><i class="fas fa-times"></i></button>
        </div>

        <!-- Categories -->
        <div class="category-tabs">
            <button class="cat-btn active" onclick="filterCategory('‡¶∏‡¶¨', this)">‡¶∏‡¶¨</button>
            <button class="cat-btn" onclick="filterCategory('‡¶ó‡¶≤‡ßç‡¶™', this)">‡¶ó‡¶≤‡ßç‡¶™</button>
            <button class="cat-btn" onclick="filterCategory('‡¶ï‡¶¨‡¶ø‡¶§‡¶æ', this)">‡¶ï‡¶¨‡¶ø‡¶§‡¶æ</button>
            <button class="cat-btn" onclick="filterCategory('‡¶°‡¶æ‡ßü‡ßá‡¶∞‡¶ø', this)">‡¶°‡¶æ‡ßü‡ßá‡¶∞‡¶ø</button>
            <button class="cat-btn" onclick="filterCategory('‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡¶ø‡¶ï', this)">‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡¶ø‡¶ï</button>
            <button class="cat-btn" onclick="filterCategory('‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø', this)">‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø</button>
        </div>

        <!-- Skeleton Loader -->
        <div id="skeletonLoader">
            <div class="skeleton-card">
                <div class="sk-header">
                    <div class="sk-avatar sk-anim"></div>
                    <div class="sk-name sk-anim"></div>
                </div>
                <div class="sk-title sk-anim"></div>
                <div class="sk-img sk-anim"></div>
                <div class="sk-line sk-anim"></div>
                <div class="sk-line sk-anim"></div>
                <div class="sk-line short sk-anim"></div>
            </div>
            <div class="skeleton-card">
                <div class="sk-header">
                    <div class="sk-avatar sk-anim"></div>
                    <div class="sk-name sk-anim"></div>
                </div>
                <div class="sk-line sk-anim"></div>
                <div class="sk-line sk-anim"></div>
            </div>
        </div>

        <div id="feed"></div>
    </div>

    <!-- Bottom Navigation Bar -->
    <nav class="bottom-nav">
        <button class="nav-item active" onclick="navAction('home', this)">
            <i class="fas fa-home"></i>
            <span>‡¶π‡ßã‡¶Æ</span>
        </button>
        <button class="nav-item" onclick="navAction('search', this)">
            <i class="fas fa-search"></i>
            <span>‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®</span>
        </button>
        <button class="nav-item" onclick="navAction('saved', this)">
            <i class="fas fa-bookmark"></i>
            <span>‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§</span>
        </button>
        <button class="nav-item" onclick="navAction('menu', this)">
            <i class="fas fa-user-cog"></i>
            <span>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®</span>
        </button>
    </nav>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBZtycgadrngON2WEwvIE7ERPYxdkDVfFM",
            authDomain: "muktolipidiary.firebaseapp.com",
            databaseURL: "https://muktolipidiary-default-rtdb.firebaseio.com",
            projectId: "muktolipidiary",
            storageBucket: "muktolipidiary.firebasestorage.app",
            messagingSenderId: "639103995400",
            appId: "1:639103995400:web:13528e51c0e86080770bbd"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        // Export Functions globally
        window.savePost = savePost;
        window.deletePost = deletePost;
        window.handleLike = handleLike;
        window.addComment = addComment;
        window.db = db; 
        window.ref = ref;
        window.update = update;
        window.remove = remove;
        window.push = push;
        window.set = set;

        window.allPosts = [];
        window.currentSearchQuery = "";
        
        // Save/Update Post
        function savePost() {
            const title = document.getElementById('postTitle').value;
            const content = document.getElementById('postContent').value;
            const author = document.getElementById('authorName').value || "‡¶Ö‡¶ú‡ßç‡¶û‡¶æ‡¶§";
            const category = document.getElementById('postCategory').value;
            const image = document.getElementById('postImage').value;
            const voice = document.getElementById('voiceUrl').value;
            const isPinned = document.getElementById('isPinned').checked;
            const editKey = document.getElementById('editKey').value;

            if (!title || !content) {
                Swal.fire({ icon: 'warning', title: '‡¶â‡¶´!', text: '‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ ‡¶ì ‡¶≤‡ßá‡¶ñ‡¶æ ‡¶¶‡¶ø‡¶§‡ßá‡¶á ‡¶π‡¶¨‡ßá!' });
                return;
            }

            const postData = {
                author, title, content, image, voice, isPinned, category,
                date: new Date().toLocaleDateString('bn-BD', { year: 'numeric', month: 'long', day: 'numeric' }),
                timestamp: Date.now()
            };

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.innerText = "‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®...";
            submitBtn.disabled = true;

            if (editKey) {
                update(ref(db, 'posts/' + editKey), postData).then(() => resetForm("‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!"));
            } else {
                postData.likes = 0;
                postData.views = 0;
                postData.comments = {};
                const newPostRef = push(ref(db, 'posts'));
                set(newPostRef, postData).then(() => resetForm("‡¶™‡¶æ‡¶¨‡¶≤‡¶ø‡¶∂ ‡¶π‡ßü‡ßá‡¶õ‡ßá!"));
            }
        }

        function resetForm(msg) {
            Swal.fire({ icon: 'success', title: '‡¶∏‡¶´‡¶≤!', text: msg, timer: 1500, showConfirmButton: false });
            document.getElementById('postTitle').value = "";
            document.getElementById('postContent').value = "";
            document.getElementById('postImage').value = "";
            document.getElementById('voiceUrl').value = "";
            document.getElementById('editKey').value = "";
            document.getElementById('postCategory').value = "‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø";
            document.getElementById('isPinned').checked = false;
            document.getElementById('submitBtn').innerText = "‡¶™‡¶æ‡¶¨‡¶≤‡¶ø‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®";
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('formTitle').innerText = "‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßã‡¶∏‡ßç‡¶ü";
            closeAdminModal();
        }

        // Data Load & Sorting
        onValue(ref(db, 'posts'), (snapshot) => {
            // Hide Skeleton
            document.getElementById('skeletonLoader').style.display = 'none';
            
            const data = snapshot.val();
            const feed = document.getElementById('feed');
            feed.innerHTML = '';
            window.allPosts = [];

            if (data) {
                const postsArr = Object.entries(data).map(([key, value]) => ({ key, ...value }));
                
                postsArr.sort((a, b) => {
                    if (a.isPinned && !b.isPinned) return -1;
                    if (!a.isPinned && b.isPinned) return 1;
                    const likesA = a.likes || 0;
                    const likesB = b.likes || 0;
                    if (likesB !== likesA) return likesB - likesA;
                    return b.timestamp - a.timestamp;
                });

                window.allPosts = postsArr;
                // Determine what to render based on current active tab
                const activeTab = document.querySelector('.cat-btn.active');
                const category = activeTab ? activeTab.innerText.trim() : '‡¶∏‡¶¨';
                
                if(category.includes("‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§")) {
                     filterCategory('‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§', activeTab);
                } else {
                     filterCategory(category, activeTab);
                }
                
            } else {
                feed.innerHTML = '<div class="no-results"><p>‡¶ï‡ßã‡¶®‡ßã ‡¶≤‡ßá‡¶ñ‡¶æ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</p></div>';
            }
        });

        function incrementView(key, currentViews) {
            const viewedPosts = JSON.parse(sessionStorage.getItem('VIEWED_POSTS')) || {};
            if (!viewedPosts[key]) {
                update(ref(db, 'posts/' + key), { views: (currentViews || 0) + 1 });
                viewedPosts[key] = true;
                sessionStorage.setItem('VIEWED_POSTS', JSON.stringify(viewedPosts));
            }
        }
        window.incrementView = incrementView;

        // Render Function with Improvements
        window.renderPosts = function(posts) {
            const feed = document.getElementById('feed');
            const likedPosts = JSON.parse(localStorage.getItem('LIKED_POSTS')) || {};
            const savedPosts = JSON.parse(localStorage.getItem('SAVED_POSTS')) || [];
            let isAdmin = localStorage.getItem('IS_ADMIN') === 'true';

            if(posts.length === 0) {
                feed.innerHTML = `
                <div class="no-results">
                    <i class="fas fa-search-minus" style="font-size:40px; margin-bottom:15px; opacity:0.5;"></i>
                    <h3>‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ‡¶ï‡ßã‡¶®‡ßã ‡¶≤‡ßá‡¶ñ‡¶æ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!</h3>
                    <button class="btn btn-primary" onclick="clearSearch()" style="width:auto; margin-top:10px;">‡¶∏‡¶¨ ‡¶≤‡ßá‡¶ñ‡¶æ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>
                </div>`;
                return;
            }

            feed.innerHTML = posts.map(post => {
                const isLong = post.content.length > 250;
                const commentsArr = post.comments ? Object.values(post.comments) : [];
                const isSaved = savedPosts.includes(post.key);
                
                // Text Formatting
                let formattedContent = post.content
                    .replace(/\*(.*?)\*/g, '<b>$1</b>')
                    .replace(/_(.*?)_/g, '<i>$1</i>');

                // Search Highlighting
                if (window.currentSearchQuery) {
                    formattedContent = highlightText(formattedContent, window.currentSearchQuery);
                    post.title = highlightText(post.title, window.currentSearchQuery);
                }
                
                setTimeout(() => incrementView(post.key, post.views), 2000); 

                // Audio Button
                let audioHtml = '';
                if(post.voice) {
                    audioHtml = `
                    <div class="audio-trigger-btn" onclick="startStickyAudio('${post.key}', '${post.title.replace(/'/g, "\\'")}', '${post.author}', '${post.voice}')">
                        <i class="fas fa-play-circle"></i> ‡¶∂‡ßÅ‡¶®‡¶§‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
                    </div>`;
                }

                return `
                <div class="post-card" id="post-${post.key}">
                    ${post.isPinned ? `<i class="fas fa-thumbtack pinned-badge" title="Pinned Post"></i>` : ''}
                    <div class="author-info">
                        <div style="background:#ddd; width:35px; height:35px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#555;">
                            <i class="fas fa-user"></i>
                        </div>
                        <div>
                            <span>${post.author}</span>
                            <div style="display:flex; align-items:center; gap:5px;">
                                <span class="date">${post.date}</span>
                                ${post.category ? `<span class="category-tag">${post.category}</span>` : ''}
                            </div>
                        </div>
                    </div>
                    <h2 class="post-title">${post.title}</h2>
                    
                    <div class="post-img-container" ondblclick="triggerDoubleTapLike('${post.key}', event)">
                        ${post.image ? `<img src="${post.image}" class="post-img" onclick="openLightbox('${post.image}')">` : ''}
                        <i class="fas fa-heart heart-popup"></i>
                    </div>

                    ${audioHtml}

                    <!-- Content with Gradient Read More -->
                    <div class="content-preview" id="text-${post.key}" ondblclick="triggerDoubleTapLike('${post.key}', event)">
                        <div class="read-more-wrapper ${isLong ? 'read-more-overlay' : 'expanded'}" id="wrapper-${post.key}">
                             ${formattedContent}
                        </div>
                        <i class="fas fa-heart heart-popup"></i>
                    </div>
                    
                    ${isLong ? `<button class="read-more-btn" onclick="toggleReadMore('${post.key}', this)">‡¶Ü‡¶∞‡¶ì ‡¶™‡ßú‡ßÅ‡¶® <i class="fas fa-chevron-down"></i></button>` : ''}

                    <div class="interaction-bar">
                        <div style="display:flex; gap:10px;">
                            <button class="action-btn ${likedPosts[post.key] ? 'liked' : ''}" id="like-btn-${post.key}" onclick="handleLike('${post.key}', ${post.likes || 0})">
                                <i class="fas fa-thumbs-up"></i> <span id="like-count-${post.key}">${post.likes || 0}</span>
                            </button>
                            <button class="action-btn" onclick="toggleComments('${post.key}')">
                                <i class="fas fa-comment-alt"></i> ${commentsArr.length}
                            </button>
                        </div>
                        
                        <div style="display:flex; gap:10px;">
                            <button class="action-btn ${isSaved ? 'bookmarked' : ''}" onclick="toggleBookmark('${post.key}', this)">
                                <i class="fas ${isSaved ? 'fa-bookmark' : 'fa-regular fa-bookmark'}"></i>
                            </button>
                            <!-- Share Button Connected -->
                            <button class="action-btn" onclick="sharePost('${post.key}')">
                                <i class="fas fa-share-nodes"></i>
                            </button>
                        </div>
                    </div>

                    <div class="comment-area" id="commentArea-${post.key}">
                        ${commentsArr.map(c => `<div class="comment-item"><b>User:</b> ${c.text}</div>`).join('')}
                        <div style="display:flex; gap:5px; margin-top:10px;">
                            <input type="text" placeholder="‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." style="margin:0; padding:10px; font-size:14px; background:var(--bg-color);">
                            <button onclick="addComment('${post.key}', this)" style="background:var(--primary-color); color:white; border:none; border-radius:10px; width:45px;"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>

                    ${isAdmin ? `
                    <div class="admin-controls">
                        <button onclick="setupEdit('${post.key}')"><i class="fas fa-edit"></i> Edit</button>
                        <button onclick="deletePost('${post.key}')" style="color:#e74c3c; border-color:#e74c3c;"><i class="fas fa-trash"></i> Delete</button>
                    </div>` : ''}
                </div>`;
            }).join('');
        }

        // Highlight Helper
        function highlightText(text, query) {
            if(!query) return text;
            try {
                const regex = new RegExp(`(${query})`, 'gi');
                return text.replace(regex, '<mark>$1</mark>');
            } catch(e) {
                return text;
            }
        }

        function handleLike(key, currentLikes) {
            const likedPosts = JSON.parse(localStorage.getItem('LIKED_POSTS')) || {};
            let newCount = currentLikes;
            
            if (!likedPosts[key]) {
                newCount = (currentLikes || 0) + 1;
                update(ref(db, 'posts/' + key), { likes: newCount });
                likedPosts[key] = true;
            } else {
                newCount = (currentLikes || 0) - 1;
                update(ref(db, 'posts/' + key), { likes: newCount });
                delete likedPosts[key];
            }
            localStorage.setItem('LIKED_POSTS', JSON.stringify(likedPosts));
        }

        function addComment(key, btn) {
            const input = btn.previousElementSibling;
            const text = input.value;
            if(!text) return;
            const commentRef = push(ref(db, 'posts/' + key + '/comments'));
            set(commentRef, { text: text, time: Date.now() });
            input.value = '';
        }

        function deletePost(key) {
            if(confirm("‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶¨‡ßá‡¶®?")) remove(ref(db, 'posts/' + key));
        }

        window.setupEdit = function(key) {
            const post = window.allPosts.find(p => p.key === key);
            if(post) {
                document.getElementById('authorName').value = post.author;
                document.getElementById('postTitle').value = post.title;
                document.getElementById('postContent').value = post.content;
                document.getElementById('postImage').value = post.image || "";
                document.getElementById('voiceUrl').value = post.voice || "";
                document.getElementById('postCategory').value = post.category || "‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø";
                document.getElementById('isPinned').checked = post.isPinned || false;
                document.getElementById('editKey').value = post.key;
                document.getElementById('formTitle').innerText = "‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶è‡¶°‡¶ø‡¶ü";
                document.getElementById('submitBtn').innerText = "‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®";
                openAdminModal();
            }
        }
    </script>

    <script>
        // --- 1. UI Interactions & Admin Logic ---
        function openAdminModal() {
            document.getElementById('adminModalWrapper').style.display = 'flex';
        }
        function closeAdminModal() {
            document.getElementById('adminModalWrapper').style.display = 'none';
        }
        
        // Show FAB if Admin
        if(localStorage.getItem('IS_ADMIN') === 'true') {
            document.getElementById('adminFab').style.display = 'flex';
        }

        function adminLogin() {
            Swal.fire({
                title: '‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®',
                input: 'password',
                showCancelButton: true,
                confirmButtonText: '‡¶≤‡¶ó‡¶á‡¶®',
            }).then((result) => {
                if (result.value === "1234") {
                    localStorage.setItem('IS_ADMIN', 'true');
                    document.getElementById('adminFab').style.display = 'flex';
                    Swal.fire('‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®!', '', 'success');
                } else if (result.value) Swal.fire('‡¶≠‡ßÅ‡¶≤ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°!', '', 'error');
            });
        }

        function logout() {
            localStorage.setItem('IS_ADMIN', 'false');
            document.getElementById('adminFab').style.display = 'none';
            closeAdminModal();
            location.reload();
        }

        // --- 2. Bottom Navigation Logic ---
        function navAction(action, btn) {
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            if (action === 'home') {
                document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
                document.querySelector('.cat-btn:first-child').classList.add('active');
                clearSearch();
                window.scrollTo({top: 0, behavior: 'smooth'});
            } else if (action === 'search') {
                window.scrollTo({top: 0, behavior: 'smooth'});
                document.getElementById('searchBar').focus();
            } else if (action === 'saved') {
                // Trigger saved category logic
                window.scrollTo({top: 0, behavior: 'smooth'});
                filterCategory('‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§', null);
                // Highlight the saved tab in top bar too visually
                document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
                const savedTab = Array.from(document.querySelectorAll('.cat-btn')).find(b => b.innerText.includes('‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§'));
                if(savedTab) savedTab.classList.add('active');
            } else if (action === 'menu') {
                if(localStorage.getItem('IS_ADMIN') === 'true') {
                    openAdminModal();
                } else {
                    adminLogin();
                }
            }
        }

        // --- 3. Read More Expand Logic ---
        function toggleReadMore(key, btn) {
            const wrapper = document.getElementById(`wrapper-${key}`);
            if (wrapper.classList.contains('read-more-overlay')) {
                wrapper.classList.remove('read-more-overlay');
                wrapper.classList.add('expanded');
                btn.innerHTML = '‡¶ï‡¶Æ‡¶ø‡ßü‡ßá ‡¶™‡ßú‡ßÅ‡¶® <i class="fas fa-chevron-up"></i>';
            } else {
                wrapper.classList.add('read-more-overlay');
                wrapper.classList.remove('expanded');
                btn.innerHTML = '‡¶Ü‡¶∞‡¶ì ‡¶™‡ßú‡ßÅ‡¶® <i class="fas fa-chevron-down"></i>';
                // Scroll back to card top if needed
                document.getElementById(`post-${key}`).scrollIntoView({behavior: "smooth", block: "start"});
            }
        }

        // --- 4. Font Size ---
        const fontSizes = ['16px', '18px', '20px'];
        let currentFontIndex = 0;
        const savedSize = localStorage.getItem('FONT_SIZE');
        if(savedSize) {
            document.documentElement.style.setProperty('--content-font-size', savedSize);
            currentFontIndex = fontSizes.indexOf(savedSize);
            if(currentFontIndex === -1) currentFontIndex = 0;
        }

        function toggleFontSize() {
            currentFontIndex = (currentFontIndex + 1) % fontSizes.length;
            const newSize = fontSizes[currentFontIndex];
            document.documentElement.style.setProperty('--content-font-size', newSize);
            localStorage.setItem('FONT_SIZE', newSize);
        }

        // --- 5. Bookmarks ---
        function toggleBookmark(key, btn) {
            let savedPosts = JSON.parse(localStorage.getItem('SAVED_POSTS')) || [];
            const index = savedPosts.indexOf(key);
            const icon = btn.querySelector('i');

            if(index === -1) {
                savedPosts.push(key);
                btn.classList.add('bookmarked');
                icon.className = "fas fa-bookmark";
                Swal.fire({toast: true, position: 'top-end', icon: 'success', title: '‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá', showConfirmButton: false, timer: 1500});
            } else {
                savedPosts.splice(index, 1);
                btn.classList.remove('bookmarked');
                icon.className = "far fa-bookmark";
            }
            localStorage.setItem('SAVED_POSTS', JSON.stringify(savedPosts));
            
            // Refresh if on saved tab
            const activeTab = document.querySelector('.cat-btn.active');
            if(activeTab && activeTab.innerText.includes("‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§")) {
                filterCategory('‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§', activeTab);
            }
        }

        // --- 6. Double Tap Like ---
        function triggerDoubleTapLike(key, event) {
            event.preventDefault();
            const container = event.currentTarget;
            const heart = container.querySelector('.heart-popup');
            if(heart) {
                heart.style.animation = 'none';
                heart.offsetHeight;
                heart.style.animation = 'popHeart 0.8s ease-out';
            }
            const likedPosts = JSON.parse(localStorage.getItem('LIKED_POSTS')) || {};
            const countSpan = document.getElementById(`like-count-${key}`);
            const currentLikes = parseInt(countSpan.innerText) || 0;
            if(!likedPosts[key]) {
                window.handleLike(key, currentLikes);
            }
        }

        // --- 7. Sticky Audio & Visualizer ---
        const stickyPlayer = document.getElementById('stickyPlayer');
        const audioEl = document.getElementById('globalAudioElement');
        const playIcon = document.getElementById('globalPlayIcon');
        const pTitle = document.getElementById('globalPlayerTitle');
        const pAuthor = document.getElementById('globalPlayerAuthor');
        const visualizer = document.getElementById('audioVisualizer');
        let currentAudioKey = null;

        function startStickyAudio(key, title, author, url) {
            if(currentAudioKey === key) {
                toggleGlobalAudio();
                return;
            }
            currentAudioKey = key;
            pTitle.innerText = title;
            pAuthor.innerText = author;
            audioEl.src = url;
            stickyPlayer.classList.add('active');
            
            audioEl.play().then(() => {
                playIcon.className = "fas fa-pause";
                visualizer.classList.add('playing');
            }).catch(e => console.log(e));
        }

        function toggleGlobalAudio() {
            if(audioEl.paused) {
                audioEl.play();
                playIcon.className = "fas fa-pause";
                visualizer.classList.add('playing');
            } else {
                audioEl.pause();
                playIcon.className = "fas fa-play";
                visualizer.classList.remove('playing');
            }
        }

        function closeGlobalPlayer() {
            audioEl.pause();
            audioEl.currentTime = 0;
            stickyPlayer.classList.remove('active');
            visualizer.classList.remove('playing');
            currentAudioKey = null;
        }
        
        function onAudioEnded() {
            playIcon.className = "fas fa-play";
            visualizer.classList.remove('playing');
        }

        // --- 8. Standard Filtering & Search ---
        window.filterCategory = function(cat, btn) {
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active'); else if (cat === '‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§') {
                 // manual highlight if called from bottom nav
            }

            document.getElementById('searchBar').value = '';
            document.getElementById('searchClearBtn').style.display = 'none';
            window.currentSearchQuery = "";
            
            if (cat === '‡¶∏‡¶¨') {
                window.renderPosts(window.allPosts);
            } else if (cat === '‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§') {
                const savedIds = JSON.parse(localStorage.getItem('SAVED_POSTS')) || [];
                const filtered = window.allPosts.filter(p => savedIds.includes(p.key));
                window.renderPosts(filtered);
            } else {
                const filtered = window.allPosts.filter(p => p.category === cat);
                window.renderPosts(filtered);
            }
        }

        window.filterPosts = function(query) {
            window.currentSearchQuery = query.toLowerCase();
            const clearBtn = document.getElementById('searchClearBtn');
            clearBtn.style.display = query.length > 0 ? 'block' : 'none';

            if(!window.allPosts) return;

            const q = query.toLowerCase();
            const filtered = window.allPosts.filter(p => 
                (p.title && p.title.toLowerCase().includes(q)) || 
                (p.content && p.content.toLowerCase().includes(q)) || 
                (p.author && p.author.toLowerCase().includes(q))
            );
            window.renderPosts(filtered);
        }

        window.clearSearch = function() {
            document.getElementById('searchBar').value = '';
            document.getElementById('searchClearBtn').style.display = 'none';
            window.currentSearchQuery = "";
            window.renderPosts(window.allPosts);
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('.cat-btn:first-child').classList.add('active');
        }

        // PWA Install
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installBtn').style.display = 'inline-block';
        });

        async function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    document.getElementById('installBtn').style.display = 'none';
                }
                deferredPrompt = null;
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
            const icon = document.querySelector('.theme-toggle i');
            icon.classList.toggle('fa-moon');
            icon.classList.toggle('fa-sun');
        }

        function toggleComments(key) {
            const el = document.getElementById(`commentArea-${key}`);
            el.style.display = (el.style.display === 'block') ? 'none' : 'block';
        }

        // Share Function (Fixed)
        function sharePost(key) {
            const post = window.allPosts.find(p => p.key === key);
            if (!post) return;

            const shareData = {
                title: '‡¶Æ‡ßÅ‡¶ï‡ßç‡¶§‡¶≤‡¶ø‡¶™‡¶ø ‡¶°‡¶æ‡ßü‡ßá‡¶∞‡¶ø',
                text: `${post.title}\n\n${post.content.substring(0, 100)}... \n‡¶™‡ßÅ‡¶∞‡ßã‡¶ü‡¶æ ‡¶™‡ßú‡ßÅ‡¶®: `,
                url: window.location.href
            };

            if (navigator.share) {
                navigator.share(shareData).catch((error) => console.log('Error sharing', error));
            } else {
                navigator.clipboard.writeText(`${shareData.text} ${shareData.url}`)
                    .then(() => Swal.fire({ icon: 'success', title: '‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶ï‡¶™‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá!', timer: 1500, showConfirmButton: false }))
                    .catch(err => Swal.fire('Error copying text'));
            }
        }

        function openLightbox(src) {
            const box = document.getElementById('lightbox');
            document.getElementById('lightbox-img').src = src;
            box.style.display = 'flex';
            setTimeout(() => box.classList.add('active'), 10);
        }
        function closeLightbox() {
            const box = document.getElementById('lightbox');
            box.classList.remove('active');
            setTimeout(() => box.style.display = 'none', 300);
        }
    </script>
</body>
</html>